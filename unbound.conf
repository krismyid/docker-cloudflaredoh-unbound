# Unbound configuration file for DNS-over-HTTPS setup
# This config routes upstream queries to cloudflared container

server:
    # Basic server configuration
    verbosity: 1
    port: 53
    interface: 0.0.0.0
    interface: ::0
    
    # Access control - allow queries from Docker network and local
    access-control: 172.20.0.0/24 allow
    access-control: 127.0.0.0/8 allow
    access-control: 10.0.0.0/8 allow
    access-control: 192.168.0.0/16 allow
    access-control: ::1/128 allow
    access-control: fc00::/7 allow
    
    # Performance and security settings
    num-threads: 2
    msg-cache-slabs: 4
    rrset-cache-slabs: 4
    infra-cache-slabs: 4
    key-cache-slabs: 4
    
    # Cache sizes (adjust based on available memory)
    rrset-cache-size: 100m
    msg-cache-size: 50m
    so-rcvbuf: 1m
    
    # Security settings
    hide-identity: yes
    hide-version: yes
    harden-glue: yes
    harden-dnssec-stripped: yes
    harden-below-nxdomain: yes
    harden-referral-path: yes
    
    # Privacy settings
    qname-minimisation: yes
    aggressive-nsec: yes
    
    # Performance tuning
    prefetch: yes
    prefetch-key: yes
    target-fetch-policy: "3 2 1 0 0"
    
    # Logging (adjust verbosity as needed)
    log-queries: no
    log-replies: no
    
    # Root hints and trust anchor (optional but recommended)
    root-hints: "/opt/unbound/etc/unbound/root.hints"
    auto-trust-anchor-file: "/opt/unbound/etc/unbound/var/root.key"

# Forward zone configuration - route all queries to cloudflared
forward-zone:
    name: "."
    # Forward to cloudflared container on port 5353
    forward-addr: cloudflared@5353
    # Enable TCP for larger responses
    forward-tcp-upstream: yes
    # Enable TLS upstream (not needed since cloudflared handles DoH)
    # forward-tls-upstream: no
